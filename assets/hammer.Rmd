---
title: "Hammer Dataset"
author: "Lieven Clement"
date: "statOmics, Ghent University (https://statomics.github.io)"
output:
    html_document:
      code_download: true
      theme: cosmo
      toc: true
      toc_float: true
      highlight: tango
      number_sections: true
---


```{r,echo=FALSE}
library(edgeR)
library(gplots)
library(pheatmap)
library(RColorBrewer)
```

# Introduction

Researchers assessed the effect of spinal nerve ligation (SNL) on the transcriptome of rats. In this experiment, transcriptome profiling occurred at two weeks and two months after treatment, for both the SNL group and a control group. Two biological replicates are used for every treatment - time combination. The researchers are interested in early and late effects and in genes for which the effect changes over time.

```{r}
file="http://bowtie-bio.sourceforge.net/recount/ExpressionSets/hammer_eset.RData"
load(url(file))
hammer.eset
```

```{r}
pData(hammer.eset)
````

```{r}
library(tidyverse)
pData(hammer.eset)
hammer.eset %>% exprs %>% head
```

# Design



The researchers are interested in an effect of the treatment at the early time point, the late timepoint and the treatment $\times$ time interaction.


```{r}
pData(hammer.eset)$time<-factor(rep(c("2m","2w"),each=4),levels = c("2w","2m"))
levels(pData(hammer.eset)$protocol)<-c("c","snl")
```

The read count $y_{ig}$ for gene $g$ of mouse $i$ are modelled as follows:

$$
\left\{
\begin{array}{lcl}
y_{ig} &\sim& NB(\mu_{ig},\phi_g)\\
E[y_{ig}\vert \mathbf{x}_{ig}]&=&\mu_{ig}\\
log(\mu_{ig})&=&\eta_{ig}\\
\eta_{ig}&=&\beta_0 + \beta_{snl} x_{snl,i} + \beta_{t2m}x_{t2m,i} + \beta_\text{snl,t2m} x_{snl,i}x_{t2m,i} + \log N_i\\
\end{array}\right.
$$

with $x_{snl,i}$ a dummy variable that is 1 if a mouse had the spinal nerve ligation and is 0 otherwise, $x_{t2m,i}$ a dummy variable that equals 1 if the mouse was sacrificed after 2 months and 0 otherwise, and, $\log{N}_i$ a normalisation offset to correct for sequencing depth. Note, that $\beta_{snl}$ is the main effect for spinal nerve ligation, and corresponds to the average log fold change between treated and control mice after two weeks. The interaction  $\beta_\text{snl,t2m}$ can be interpreted as the average change in log FC between treated and control mouse at the late and early timepoint. The researchers are also interested in a assessing third contrast: the effect of the treatment at the late time point.

$$ \log \text{FC}^\text{2 months}_\text{snl-c}= \beta_{snl}+\beta_{snl,t2m}$$


The design matrix is constructed for the linear predictor.


```{r}
dge <- DGEList(counts=exprs(hammer.eset))
dge$sample
```

```{r}
design <- model.matrix(~time*protocol,pData(hammer.eset))
rownames(design) = colnames(dge)
design
```

Filtering
```{r}
keep <- filterByExpr(dge, design)
 dge <- dge[keep, , keep.lib.sizes=FALSE]
```

```{r}
dge <- calcNormFactors(dge)
dge$samples
```

# Data exploration

An MDS plot shows the leading log fold changes between the 8 samples. There is a large effect according to the SNL. Are there issues with the design?

```{r}
plotMDS(dge,labels=paste(hammer.eset$protocol,hammer.eset$time,sep="-"),col=as.double(hammer.eset$protocol))
```

# Analysis


```{r}
dge <- estimateDisp(dge, design, robust=TRUE)  
plotBCV(dge)
fit <- glmFit(dge,design)
```


## Early

DE at the early timepoint can be assessed by testing the null hypothesis

$$
H_0: \log \text{FC}^\text{2 weeks}_\text{snl-c}=0 \rightarrow \beta_\text{snl}=0
$$

against the two side alternative hypothesis

$$
H_1: \log \text{FC}^\text{2 weeks}_\text{snl-c}\neq 0 \rightarrow \beta_\text{snl}\neq0
$$

```{r}
early <- glmLRT(fit,coef="protocolsnl")
ttEarly<-topTags(early, n = nrow(dge)) # all genes
hist(ttEarly$table$PValue,main="early",xlab="p-values")
summary(dtEarly <- decideTestsDGE(early))
volcano<- ggplot(ttEarly$table,aes(x=logFC,y=-log10(PValue),color=FDR<0.05)) + geom_point() + scale_color_manual(values=c("black","red"))
volcano
plotSmear(early,de.tags=rownames(dge)[as.logical(dtEarly)],ylab="log FC_late - log FC_early")
```

Because there are `r sum(as.logical(dtEarly))` significant genes we restrict the heatmap to the top 30 genes.

```{r}
pheatmap(cpm(dge,log=TRUE)[rownames(ttEarly$table)[1:30],],labels_col = paste(hammer.eset$protocol,hammer.eset$time,sep="-"))
```


## Late

The effect of the treatment after two months can be estimated by the log fold change corresponding to the sum of the main effect and the interaction.
This can be assessed by testing the null hypothesis

$$
H_0: \log \text{FC}^\text{2 months}_\text{snl-c}=0 \rightarrow \beta_\text{snl}+\beta_\text{snl,t2m}=0
$$

against the two side alternative hypothesis

$$
H_1: \log \text{FC}^\text{2 months}_\text{snl-c}\neq0 \rightarrow \beta_\text{snl}+\beta_\text{snl,t2m}\neq0
$$


```{r}
L<-array(0,ncol(design))
names(L)<-colnames(design)
L[c(3,4)] <- 1
L
late<-glmLRT(fit,contrast=L)
ttLate<-topTags(late, n = nrow(dge)) # all genes
hist(ttLate$table$PValue,main="late",xlab="p-values")
summary(dtLate <- decideTestsDGE(late))
volcano<- ggplot(ttLate$table,aes(x=logFC,y=-log10(PValue),color=FDR<0.05)) + geom_point() + scale_color_manual(values=c("black","red"))
volcano
plotSmear(late,de.tags=rownames(dge)[as.logical(dtLate)],ylab="log FC_late - log FC_early")
```

Because there are `r sum(as.logical(dtLate))` significant genes we restrict the heatmap to the top 30 genes.

```{r}
pheatmap(cpm(dge,log=TRUE)[rownames(ttLate$table)[1:30],],labels_col = paste(hammer.eset$protocol,hammer.eset$time,sep="-"))
```

## Interaction

To assess if the treatment effect changes over time, we will test the null hypothesis that the interaction term equals zero vs the alternative that the interaction term is different from zero.  

This can be assessed by testing the null hypothesis

$$
H_0: \log \text{FC}^\text{2 months}_\text{snl-c}-\log \text{FC}^\text{2 weeks}_\text{snl-c}=0 \rightarrow \beta_\text{snl,t2m}=0
$$

against the alternative hyptothesis

$$
H_1: \log \text{FC}^\text{2 months}_\text{snl-c}-\log \text{FC}^\text{2 weeks}_\text{snl-c}\neq0 \rightarrow \beta_\text{snl,t2m}\neq0
$$

```{r}
inter <- glmLRT(fit,coef="time2m:protocolsnl")
ttInter<-topTags(inter, n = nrow(dge)) # all genes
hist(ttInter$table$PValue,main="interaction",xlab="p-values")
summary(dtInter <- decideTestsDGE(inter))
volcano<- ggplot(ttInter$table,aes(x=logFC,y=-log10(PValue),color=FDR<0.05)) + geom_point() + scale_color_manual(values=c("black","red"))
volcano
plotSmear(inter,de.tags=rownames(dge)[as.logical(dtInter)],ylab="log FC_late - log FC_early")
```

Because there are `r sum(as.logical(dtInter))` significant genes we plot them all in the heatmap.

```{r}
pheatmap(cpm(dge,log=TRUE)[as.logical(dtInter),],labels_col = paste(hammer.eset$protocol,hammer.eset$time,sep="-"))
```

## Remarks

- There are very many DE genes according to the SNL treatment at the early and late timepoint.

- Issues with the design?

- There are very few interactions significant. Can you explain this?

# Assess p-values

```{r}
ttEarly$table <- ttEarly$table %>%
  mutate(z = sign(logFC) * abs(qnorm(PValue/2)))

ttEarly$table %>%
  ggplot(aes(x=z)) +
  geom_histogram(aes(y = ..density..), color = "black") +
  stat_function(fun = dnorm,
      args = list(
    mean = 0,
    sd=1)
  )
```
